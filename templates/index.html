<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ãŒå®¶ã®ãƒªã‚¹ãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        h1 { font-size: 20px; color: #333; margin-bottom: 20px; }
        .card { background: white; padding: 15px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .content { flex-grow: 1; }
        .type-badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 4px; }
        .bg-task { background-color: #ff9f43; }
        .bg-event { background-color: #54a0ff; }
        .summary { font-size: 16px; font-weight: bold; color: #333; }
        .date { color: #888; font-size: 13px; margin-top: 2px; }
        
        /* å®Œäº†ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .done-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            flex-shrink: 0; /* ãƒœã‚¿ãƒ³ãŒæ½°ã‚Œãªã„ã‚ˆã†ã« */
        }
        .done-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <h1>ğŸ“ å…±æœ‰ãƒªã‚¹ãƒˆ</h1>
    <div id="list-container">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <script>
        // â˜…â˜…â˜… ã“ã“ã ã‘è‡ªåˆ†ã®ã‚­ãƒ¼ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼ â˜…â˜…â˜…
        const SUPABASE_URL = "https://ygnafllntoczlrkwluax.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnbmFmbGxudG9jemxya3dsdWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NjM3NDcsImV4cCI6MjA4MDEzOTc0N30.Ny_J6U3x23CPvJckmvUznK24lYOwq62fk17fZKm18cM";

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function fetchTasks() {
            const { data, error } = await client
                .from('tasks')
                .select('*')
                .order('created_at', { ascending: false });

            const container = document.getElementById('list-container');
            container.innerHTML = "";

            if (error) { console.error(error); return; }
            if (!data || data.length === 0) {
                container.innerHTML = "<p style='color:#888; text-align:center;'>ç¾åœ¨ãƒªã‚¹ãƒˆã¯ç©ºã£ã½ã§ã™ğŸ‰</p>";
                return;
            }

            data.forEach(item => {
                const typeClass = item.type === 'task' ? 'bg-task' : 'bg-event';
                const typeName = item.type === 'task' ? 'è²·ã†/ã‚„ã‚‹' : 'äºˆå®š';
                
                // ãƒœã‚¿ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã‚€
                const html = `
                    <div class="card" id="card-${item.id}">
                        <div class="content">
                            <span class="type-badge ${typeClass}">${typeName}</span>
                            <div class="summary">${item.summary}</div>
                            <div class="date">${item.date || ""}</div>
                        </div>
                        <button class="done-btn" onclick="completeTask('${item.id}', '${item.summary}', '${item.source_id || ""}')">
                            å®Œäº†ï¼
                        </button>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // å®Œäº†ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        async function completeTask(id, summary, sourceId) {
            if(!confirm(`ã€Œ${summary}ã€ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            // 1. ç”»é¢ã‹ã‚‰æ¶ˆã™ï¼ˆã‚µã‚¯ã‚µã‚¯æ„Ÿã®ãŸã‚å…ˆã«æ¶ˆã™ï¼‰
            document.getElementById(`card-${id}`).style.display = 'none';

            // 2. ã‚µãƒ¼ãƒãƒ¼ã«é€£çµ¡ã™ã‚‹
            try {
                await fetch('/complete_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, summary: summary, source_id: sourceId })
                });
            } catch (e) {
                console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼", e);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }

        fetchTasks();
    </script>
</body>
</html>